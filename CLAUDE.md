# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands

```bash
just build          # Build the binary (ks-bin)
just run            # Run with debug logging (RUST_LOG=debug)
just check          # Format check + clippy lints
just fmt            # Format code
just install        # Install binary locally
cargo build --release  # Optimized release build (stripped, opt-level "z")
```

## Architecture

**kitchnsink** is a Wayland status bar built with ratatui for TUI rendering and smithay-client-toolkit for Wayland layer shell integration. Part of the `kitchn` ecosystem.

### Workspace Structure

- **ks-core**: Core library - rendering logic, configuration, state management, and the Dish trait system
- **ks-wayland**: Wayland integration via SCTK - layer shell setup, event handling, text rendering with fontdue
- **ks-bin**: Binary entry point - CLI (clap), tokio runtime, TUI manager mode, debug socket logging

### Dish System (Widget Architecture)

Widgets are called "Dishes" and implement the `Dish` trait (`ks-core/src/dish.rs`):

```rust
pub trait Dish: Send + Sync {
    fn name(&self) -> &str;
    fn render(&self, area: Rect, buf: &mut Buffer, state: &BarState);
    fn width(&self, state: &BarState) -> u16;
}
```

Dishes are instantiated in `ks-core/src/renderer.rs` based on config module lists. Add new dishes in `ks-core/src/dishes/`.

### Configuration Pattern ("Dumb Receiver")

- **Layout/Style**: Read from `~/.config/kitchnsink/sink.toml` (generated by `kitchn cook`)
- **Logging strings**: Externalized via `k-lib` Cookbook dictionary (keys like `sink_startup`, `dish_loaded`)
- Config struct hierarchy: `SinkConfig` â†’ `WindowConfig`, `StyleConfig`, `LayoutConfig`, plus `dish` HashMap for per-dish settings

### Rendering Flow

1. `BarState` holds runtime data (cpu, mem, time) plus config and cookbook
2. `BarRenderer` manages a ratatui `Buffer`, dishes per section (left/center/right), and tachyonfx effects
3. `WaylandState` blits the buffer to a Wayland surface via SCTK layer shell

### Key Dependencies

- `k-lib` (from `ryugen-io/kitchN`): Provides `Cookbook` config and logging utilities
- `ratatui`: TUI buffer/widget rendering
- `tachyonfx`: Visual effects (fade, etc.)
- `smithay-client-toolkit`: Wayland protocols
- `fontdue`: Font rasterization for Wayland surface

## Debug Mode

Run with `--debug` to spawn a separate terminal tailing logs via Unix socket (`kitchnsink-debug.sock`). Uses tracing with a custom socket subscriber layer.
